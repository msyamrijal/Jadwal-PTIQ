const dataByClass = {
  "PTIQ": {
    "Sejarah Peradaban Islam": {
      "2025-04-21": ["Noviyatul Badriyah", "Ibnatul Mardiah"],
      "2025-04-28": ["Nailul Khoiril Marom", "M. Syamsur Rijal"],
      "2025-05-05": ["Nurul Huda", "M. Iskhak Nawawi"],
      "2025-05-12": ["Nur Kholisah", "Nurul Jannah"],
      "2025-05-19": ["Saepul", "M. Imdadur Rachman"],
      "2025-05-26": ["Yolan Hardika Pratama", "Muh. Ikbal Amsah"],
      "2025-06-02": ["Farhani Azkia", "Putri Salsabila Azkya"],
      "2025-06-09": ["Salman Alfarezi", "M. Subulul Hikam"],
      "2025-06-16": ["M. Imran", "Zaky Zimmatillah Zulfikar"],
      "2025-06-23": ["M. Imdadur Rachman", "Muh. Ikbal Amsah"]
    },
    "Filsafat Ilmu": {
      "2025-04-21": ["M. Subulul Hikam", "Zaeni Anwar"],
      "2025-04-28": ["Nurul Jannah", "Farhani Azkia"],
      "2025-05-05": ["M. Iskhak Nawawi", "Zaky Zimmatillah Zulfikar"],
      "2025-05-12": ["Nailul Khoiril Marom", "Yolan Hardika Pratama"],
      "2025-05-19": ["Siti Muliana", "Noviyatul Badriyah"],
      "2025-05-26": ["M. Syamsur Rijal", "Nur Ardhiansyah KH"],
      "2025-06-02": ["Muh. Ikbal Amsah", "Zulfi Fadhlurrahman"],
      "2025-06-09": ["Saepul", "Rusdi"]
    },
    "Pendekatan dalam Kajian Islam": {
      "2025-04-28": ["Saepul", "Salman Alfarezi", "Nurul Huda", "Rusdi"],
      "2025-05-05": ["Yolan Hardika Pratama", "Zaeni Anwar"],
      "2025-05-12": ["Zaky Zimmatillah Zulfikar", "Zulfi Fadhlurrahman"],
      "2025-05-19": ["Farhani Azkia", "Hilya Hasna Nabila"],
      "2025-05-26": ["Ibnatul Mardiah", "Noviyatul Badriyah"],
      "2025-06-02": ["Nur Kholisah", "Nurul Jannah"],
      "2025-06-09": ["Putri Salsabila Azkya", "Siti Muliana"]
    },
    "Ulumul Qurâ€™an": {
      "2025-04-24": ["M. Imran", "Putri Salsabila Azkya"],
      "2025-05-01": ["M. Imdadur Rachman", "Rusdi"],
      "2025-05-08": ["Zaky Zimmatillah Zulfikar", "Nur Ardhiansyah KH"],
      "2025-05-15": ["M. Syamsur Rijal", "Farhani Azkia"],
      "2025-05-22": ["Saepul", "M. Subulul Hikam"],
      "2025-05-29": ["Zaeni Anwar", "Muh. Ikbal Amsah"],
      "2025-06-05": ["Siti Muliana", "Nurul Huda"],
      "2025-06-12": ["Yolan Hardika Pratama"],
      "2025-06-19": ["Nailul Khoiril Marom"]
    },
    "Sejarah dan Pemikiran Tafsir di Indonesia": {
      "2025-04-24": ["Farhani Azkia", "Putri Salsabila Azkya"],
      "2025-05-01": ["Muhamad Imdadur Rachman", "Zaky Zimmatillah Zulfikar"],
      "2025-05-08": ["Zaeni Anwar", "Zulfi Fadhlurrahman"],
      "2025-05-15": ["Nurul Huda", "Muchamad Subulul Hikam"],
      "2025-05-22": ["Yolan Hardika Pratama", "Rusdi"],
      "2025-05-29": ["Muhammad Syamsur Rijal", "Nur Ardhiansyah Khalillurahman Ibrahim"],
      "2025-06-05": ["Mukhamad Iskhak Nawawi", "Nailul Khoiril Marom"],
      "2025-06-12": ["Saepul", "Salman Alfarezi"],
      "2025-06-19": ["Hilya Hasna Nabila", "Nur Kholisah"]
    },
    "Sejarah Pemikiran Islam": {
      "2025-04-24": ["M. Syamsur Rijal", "Nur Kholisah", "Nurul Huda", "Zaky Zimmatillah Zulfikar"],
      "2025-05-01": ["M. Subulul Hikam", "Zaeni Anwar", "M. Imdadur Rachman", "M. Imran"],
      "2025-05-08": ["Nailul Khoiril Marom", "Saepul", "Zulfi Fadhlurrahman", "Salman Alfarezi"],
      "2025-05-15": ["Yolan Hardika Pratama", "Rusdi", "Hilya Hasna Nabila", "Muh. Ikbal Amsah"],
      "2025-05-22": ["Nur Ardhiansyah KH", "Siti Muliana", "Nurul Jannah", "Noviyatul Badriyah"],
      "2025-05-29": ["Putri Salsabila Azkya", "Farhani Azkia", "Ibnatul Mardiah", "M. Iskhak Nawawi"],
      "2025-06-05": ["M. Syamsur Rijal", "Nur Kholisah", "Nurul Huda", "Zaky Zimmatillah Zulfikar"],
      "2025-06-12": ["M. Subulul Hikam", "Zaeni Anwar", "M. Imdadur Rachman", "M. Imran"],
      "2025-06-19": ["Nailul Khoiril Marom", "Saepul", "Zulfi Fadhlurrahman", "Salman Alfarezi"]
    }
  },
  
  "PKU B": {
  "Tarjih": {
    "2025-04-19": ["Triyanti Nurhikmah", "Muhammad Syamsur Rijal", "Nailul Khoiril Marom", "Zaky Zimmatillah Zulfikar", "Zaeni Anwar", "Nurul Huda", "Muhamad Imdadur Rachman"],
    "2025-04-26": ["Nurfaizah Jamaluddin", "Rusdi", "Mukhamad Iskhak Nawawi", "Muhammad Imran", "Salman Alfarezi Muchamad", "Zulfi Fadhlurrahman"],
    "2025-05-03": ["Saepul", "Subulul Hikam", "Umiatu Rohmah", "Yolan Hardika Pratama", "Muh. Ikbal Amsah", "Nur Ardhiansyah Khalillurahman Ibrahim"]
  },
  "Epistemologi Islam": {
    "2025-04-23": ["Umiatu Rohmah", "Muchamad Subulul Hikam"],
    "2025-04-30": ["Yolan Hardika Pratama"],
    "2025-05-07": ["Triyanti Nurhikmah"],
    "2025-05-14": ["Salman Alfarezi"],
    "2025-05-21": ["Zaeni Anwar"],
    "2025-05-28": ["Zaky Zimmatillah Zulfikar"],
    "2025-06-04": ["Nurul Huda"],
    "2025-06-11": ["Saepul"],
    "2025-06-18": ["Nurfaizah Jamaluddin"],
    "2025-06-25": ["Mukhamad Iskhak Nawawi"]
  },
  "Bahasa Arab": {
    "2025-04-22": ["Muhammad Imran", "Muh. Ikbal Amsah"],
    "2025-04-29": ["Nailul Khoiril Marom", "Muhamad Imdadur Rachman"],
    "2025-05-06": ["Zulfi Fadhlurrahman", "Muhammad Syamsur Rijal"],
    "2025-05-13": ["Triyanti Nurhikmah", "Rusdi"],
    "2025-05-20": ["Yolan Hardika Pratama", "Mukhamad Iskhak Nawawi"],
    "2025-05-27": ["Nurul Huda", "Muchamad Subulul Hikam"],
    "2025-06-03": ["Nur Ardiansyah K. I."]
  },
  "Perbandingan Madzhab": {
    "2025-04-22": ["Nur Ardhiansyah Khalillurahman Ibrahim", "Nurfaizah Jamaluddin", "Zaky Zimmatillah Zulfikar", "Zulfi Fadhlurrahman"],
    "2025-04-29": ["Nurul Huda", "Rusdi"],
    "2025-05-06": ["Saepul", "Salman Al Farezi"],
    "2025-05-13": ["Triyanti Nurkhikmah", "Umiatu Rohmah"]
  },
  "Kajian Lintas Agama": {
    "2025-04-23": ["Salman Alfarezi", "Nurul Huda"],
    "2025-04-30": ["Nurfaizah Jamaluddin", "Muhammad Syamsur Rijal"],
    "2025-05-07": ["Triyanti Nurhikmah", "Muhamad Imdadur Rachman"],
    "2025-05-14": ["Nailul Khoiril Marom", "Saepul"],
    "2025-05-21": ["Muchamad Subulul Hikam", "Umiatu Rohmah"],
    "2025-05-28": ["Yolan Hardika Pratama", "Muh. Ikbal Amsah"],
    "2025-06-04": ["Rusdi", "Mukhamad Iskhak Nawawi"],
    "2025-06-11": ["Zaeni Anwar", "Zulfi Fadhlurrahman"]
  },
  "Tafsir Gender dan Sufisme": {
    "2025-04-18": ["Nailul Khoiril Marom", "Umiatu Rohmah"],
    "2025-04-25": ["Muchamad Subulul Hikam", "Rusdi"],
    "2025-05-02": ["Muhammad Syamsur Rijal", "Muhamad Imdadur Rachman"],
    "2025-05-09": ["Salman Alfarezi", "Muh. Ikbal Amsah"],
    "2025-05-16": ["Yolan Hardika Pratama"],
    "2025-05-23": ["Triyanti Nurhikmah"],
    "2025-05-30": ["Saepul"],
    "2025-06-06": ["Muhammad Imran"],
    "2025-06-13": ["Nur Ardhiansyah Khalillurahman Ibrahim"]
  },
  "Bahasa Inggris": {
    "2025-04-18": ["M. Iskhak Nawawi", "Nailul Khoiril Marom", "Nurul Huda", "Ahmad Mahrus"],
    "2025-04-25": ["Ince", "Triyanti Nurhikmah", "Adam Azizi", "Zulfi Fadhlurrahman"],
    "2025-05-02": ["Nurfaizah Jamaluddin", "Abdul Jabar", "Moh. Fadlurrahman"],
    "2025-05-09": ["Umiatu Rohmah", "M. Iqbal", "Muhammad Imran"],
    "2025-05-16": ["Azhar", "Hilal", "Salman Alfarezi"],
    "2025-05-23": ["Darmawangsa", "Lukman", "Saepul"],
    "2025-05-30": ["Muh. Ikbal Amsah", "Imamull Burhan", "Iqbal Salafuddin"],
    "2025-06-06": ["Nur Ardiansyah K. I.", "Ahmad Sayyid", "M. Imdadur Rachman"],
    "2025-06-13": ["Dannu", "Agung Setiabudi", "Yolan Hardika Pratama"],
    "2025-06-20": ["Al Fahrizal", "Zaky Zimmatillah Zulfikar", "Muchamad Subulul Hikam"],
    "2025-06-27": ["Fasrul", "Zaeni Anwar", "Muhammad Syamsur Rijal"]
  },
  "Dakwah dan Komunikasi Islam": {
    "2025-04-18": ["Muchamad Subulul Hikam (B)"],
    "2025-04-25": ["Muh. Ikbal Amsah (B)"],
    "2025-05-02": ["Muhamad Imdadur Rachman (B)"],
    "2025-05-09": ["Muhammad Imran (B)"],
    "2025-05-16": ["Muhammad Syamsur Rijal (B)"],
    "2025-05-23": ["Mukhamad Iskhak Nawawi (B)"],
    "2025-05-30": ["Nailul Khairil Marom (B)"],
    "2025-06-06": ["Nur Ardhiansyah Khalillurahman Ibrahim (B)"],
    "2025-06-13": ["Triyanti Nurhikmah (B)", "Nurfaizah Jamaluddin (B)"],
    "2025-06-20": ["Umiatu Rohmah (B)", "Nurul Huda (B)"],
    "2025-06-27": ["Yolan Hardika Pratama (B)", "Rusdi (B)"],
    "2025-07-04": ["Zaeni Anwar (B)", "Saepul (B)"],
    "2025-07-11": ["Zaky Zimmatillah Zulfikar (B)", "Salman Alfarezi (B)", "Zulfi Fadlurrahman (B)"]
  }
},
  
  "PKUP": {
  "Tafsir Prespektif Gender dan Sufisme": {
    "2025-04-25": ["Noviatul Badriyah", "Nurul Jannah"],
    "2025-05-02": ["Siti Muliana", "Ibnatul Mardhiyah"],
    "2025-05-09": ["Nur Khalisah", "Farhani Azkiya"],
    "2025-05-16": ["Hilya Hasna Nabila", "Putri Salsabila Azkiya"]
  },
  "Bahasa Arab": {
    "2025-04-18": ["Hilya Hasna Nabila", "Nur Khalisah"],
    "2025-04-22": ["Putri Salsabila Azkiya", "Farhani Azkiya"],
    "2025-04-25": ["Siti Muliana", "Ibnatul Mardhiyah"],
    "2025-04-29": ["Noviatul Badriyah", "Nurul Jannah"]
  },
  "Perbandingan Mazhab": {
    "2025-02-12": ["Noviatul Badriyah", "Nurul Jannah"],
    "2025-02-19": ["Nur Khalisah", "Farhani Azkiya"],
    "2025-02-26": ["Hilya Hasna Nabila", "Ibnatul Mardhiyah"],
    "2025-04-16": ["Putri Salsabila Azkiya", "Siti Muliana"],
    "2025-04-23": ["Noviatul Badriyah", "Nurul Jannah"],
    "2025-04-30": ["Nur Khalisah", "Farhani Azkiya"],
    "2025-05-07": ["Hilya Hasna Nabila", "Ibnatul Mardhiyah"],
    "2025-05-14": ["Putri Salsabila Azkiya", "Siti Muliana"],
    "2025-05-21": ["Noviatul Badriyah", "Nurul Jannah"],
    "2025-05-28": ["Nur Khalisah", "Farhani Azkiya"],
    "2025-06-04": ["Hilya Hasna Nabila", "Ibnatul Mardhiyah"]
  },
  "Tafsir dan Fiqh Gender": {
    "2025-04-25": ["Siti Muliana"],
    "2025-05-02": ["Noviatul Badriyah"],
    "2025-05-09": ["Hilya Hasna Nabila"],
    "2025-05-16": ["Nurul Jannah"],
    "2025-05-23": ["Farhani Azkiya"],
    "2025-05-30": ["Putri Salsabila Azkiya"],
    "2025-06-06": ["Nur Khalisah"],
    "2025-06-13": ["Ibnatul Mardhiyyah"]
  },
  "Konsep dan Teori Gender": {
    "2025-02-14": ["Farhani Azkiya"],
    "2025-02-21": ["Hilya Hasna Nabila"],
    "2025-02-28": ["Ibnatul Mardhiyyah"],
    "2025-04-18": ["Noviatul Badriyah"],
    "2025-04-25": ["Nur Khalisah"],
    "2025-05-02": ["Nurul Jannah"],
    "2025-05-09": ["Putri Salsabila Azkiya"],
    "2025-05-16": ["Siti Muliana"]
  }
}

};


// Debounce helper
function debounce(fn, delay) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => fn(...args), delay);
  };
}

// Format tanggal ke bahasa Indonesia
function formatTanggalIndo(dateStr) {
  const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
  const months = [
    'Januari','Februari','Maret','April','Mei','Juni',
    'Juli','Agustus','September','Oktober','November','Desember'
  ];
  const d = new Date(dateStr);
  const dayName = days[d.getDay()];
  const day = String(d.getDate()).padStart(2,'0');
  const month = months[d.getMonth()];
  const year = d.getFullYear();
  return `${dayName}, ${day} ${month} ${year}`;
}

// Generate array event untuk FullCalendar
function generateEventList(data) {
  const events = [];
  for (const className in data) {
    for (const subject in data[className]) {
      for (const date in data[className][subject]) {
        const names = data[className][subject][date];
        const title = `${names.slice(0,2).join(', ')}${names.length>2? ', ...':''}`;
        events.push({
          title,
          date,
          detail: `Kelas: ${className}<br>Mata Kuliah: ${subject}<br>Nama: ${names.join(', ')}`
        });
      }
    }
  }
  return events;
}

// Ambil elemen global
const classSelect   = document.getElementById("class-select");
const subjectSelect = document.getElementById("subject-select");
const nameInput     = document.getElementById("search-name");
const resultsDiv    = document.getElementById("results");

// Akan diisi pada DOMContentLoaded
let calendarEl, printContainer;

document.addEventListener('DOMContentLoaded', () => {
  // Inisialisasi elemen kalender & tombol cetak
  calendarEl      = document.getElementById('calendar');
  printContainer  = document.querySelector('.print-button-container');

  // Inisialisasi FullCalendar
  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'id',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: ''
    },
    events: generateEventList(dataByClass),
    eventClick: info => {
      // tampilkan popup dengan detail
      const detail = info.event.extendedProps.detail;
      document.getElementById('popup-content').innerHTML = `<p>${detail}</p>`;
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('popup').style.display   = 'block';
    }
  });
  calendar.render();

  // Pasang listener dengan debounce pada input nama
  classSelect.addEventListener('change', () => { updateSubjects(); showResults(); });
  subjectSelect.addEventListener('change', showResults);
  nameInput.addEventListener('input', debounce(showResults, 300));

  // Setup awal
  updateSubjects();
  showResults();

  // Fitur popup "Add to Home Screen" di mobile
  if (window.matchMedia('(max-width: 768px)').matches) {
    setTimeout(function() {
      const popup = document.getElementById('add-to-home-popup');
      popup.style.display = 'block';
    }, 1000);  // Tunda 1 detik setelah halaman dimuat

    // Close popup ketika tombol close diklik
    document.getElementById('close-popup').addEventListener('click', function() {
      document.getElementById('add-to-home-popup').style.display = 'none';
    });

    // Tombol Tambah ke Layar Utama
    document.getElementById('add-to-home').addEventListener('click', function() {
      if (window.matchMedia('(display-mode: standalone)').matches) {
        alert("Situs sudah di layar utama!");
      } else {
        // Menambahkan aplikasi ke layar utama (untuk PWA)
        if (window.deferredPrompt) {
          window.deferredPrompt.prompt();  // Memicu prompt "Add to Home Screen"
          window.deferredPrompt.userChoice
            .then(function(choiceResult) {
              window.deferredPrompt = null;
              console.log(choiceResult.outcome);
            });
        }
      }
    });

    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      console.log("App bisa dipasang!");
    });
  }
});

function closePopup() {
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('popup').style.display   = 'none';
}

// Update daftar mata kuliah di dropdown
function updateSubjects() {
  const sel = classSelect.value;
  let subjects = [];

  if (sel === 'all') {
    const all = new Set();
    Object.values(dataByClass)
      .forEach(cd => Object.keys(cd).forEach(s => all.add(s)));
    subjects = Array.from(all);
  } else {
    subjects = Object.keys(dataByClass[sel] || {});
  }

  // Reset dan isi ulang options
  subjectSelect.innerHTML = '<option value="">Semua Mata Kuliah</option>';
  const frag = document.createDocumentFragment();
  subjects.forEach(s => {
    const opt = document.createElement('option');
    opt.value       = s;
    opt.textContent = s;
    frag.appendChild(opt);
  });
  subjectSelect.appendChild(frag);
}

// Tampilkan / filter hasil, dan sembunyikan kalender jika ada query
function showResults() {
  const nameQuery = nameInput.value.trim().toLowerCase();

  // Hide / show kalender & tombol cetak
  if (nameQuery) {
    calendarEl.style.display      = 'none';
    printContainer && (printContainer.style.display = 'none');
  } else {
    calendarEl.style.display      = '';
    printContainer && (printContainer.style.display = '');
  }

  resultsDiv.innerHTML = '';
  const today = new Date(); today.setHours(0,0,0,0);
  const selClass   = classSelect.value;
  const selSubj    = subjectSelect.value;
  const classes    = selClass === 'all' ? Object.keys(dataByClass) : [selClass];
  const matches    = [];

  // Kumpulkan match
  classes.forEach(cl => {
    const subs = dataByClass[cl] || {};
    for (const subject in subs) {
      if (selSubj && subject !== selSubj) continue;
      for (const date in subs[subject]) {
        const eventDate = new Date(date); eventDate.setHours(0,0,0,0);
        if (eventDate < today) continue;
        const group = subs[subject][date];
        const hasMatch = nameQuery
          ? group.some(n => n.toLowerCase().includes(nameQuery))
          : true;
        if (hasMatch) {
          matches.push({ class: cl, subject, date, group, query: nameQuery });
        }
      }
    }
  });

  // Sort by date
  matches.sort((a,b) => new Date(a.date) - new Date(b.date));

  // Render kartu
  matches.forEach(m => {
    const card = document.createElement('div');
    card.className = 'result-card';

    // Tanggal
    const meta1 = document.createElement('div'); meta1.className = 'card-meta';
    meta1.innerHTML = `<i class="fa-solid fa-calendar-day"></i>`;
    const dateEl = document.createElement('span');
    dateEl.className = 'card-date';
    dateEl.textContent = formatTanggalIndo(m.date);
    meta1.appendChild(dateEl);

    // Mata Kuliah
    const meta2 = document.createElement('div'); meta2.className = 'card-meta';
    meta2.innerHTML = `<i class="fa-solid fa-book"></i><span>${m.subject}</span>`;

    // Group
    const groupDiv = document.createElement('div'); groupDiv.className = 'card-group';
    groupDiv.innerHTML = `<i class="fa-solid fa-users"></i>` +
      m.group.map(name =>
        name.toLowerCase().includes(m.query)
          ? `<span class="highlight">${name}</span>`
          : name
      ).join(', ');

    // Kelas
    const meta3 = document.createElement('div'); meta3.className = 'card-meta';
    meta3.innerHTML = `<i class="fa-solid fa-chalkboard-user"></i><span>Kelas: ${m.class}</span>`;

    [meta1, meta2, groupDiv, meta3].forEach(el => card.appendChild(el));
    resultsDiv.appendChild(card);
  });
}

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js')
    .then(() => console.log('SW registered'))
    .catch(err => console.error('SW registration failed:', err));
}

